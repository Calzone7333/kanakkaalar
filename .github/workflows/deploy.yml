name: Deploy Kanakkaalar to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e # Stop script on error

          echo "Starting Deployment for Kanakkaalar..."
          
          # Navigate to project directory
          cd /var/www/kanakkaalar

          # Pull latest changes
          sudo git fetch --all
          sudo git reset --hard origin/main

          # --- Backend Build (Spring Boot) ---
          echo "Building Backend..."
          cd backend
          # Build the jar, skipping tests for speed
          sudo mvn clean package -DskipTests
          
          # Restart Backend Process
          echo "Restarting Backend Process..."
          sudo pm2 restart kanakkaalar-backend || sudo pm2 start target/financial-backend-0.0.1-SNAPSHOT.jar --name kanakkaalar-backend -- port 8081

          # --- Frontend Build (React) ---
          echo "Building Frontend..."
          cd ../frontend
          sudo npm install
          
          # Fix potential memory issues during build if on random small instance
          export NODE_OPTIONS="--max-old-space-size=4096"
          sudo npm run build
          
          # --- Finalize ---
          # Reload Apache to serve new statics/configs if changed
          sudo systemctl reload apache2

          echo "Deployment Complete!"
