import{j as e}from"./ui-Ch41-bI7.js";import{b as F,r as i}from"./vendor-Con1GFA2.js";import{g as y,u as k,s as C,b as R}from"./index-DOyQY1V8.js";import{U as A}from"./user-jfsMiT04.js";import"./utils-BMGruD9E.js";function O(){const r=F(),j=y(),[c,f]=i.useState((j==null?void 0:j.user)||null),[h,U]=i.useState(!0),[L,I]=i.useState(!1),[N,g]=i.useState(null),[v,n]=i.useState(null);let o=null;i.useEffect(()=>{let d=!0;if(o){try{URL.revokeObjectURL(o)}catch{}o=null}return c!=null&&c.hasProfileImage?(async()=>{try{const m=await k.profileImage();if(!d)return;const x=m.data,u=URL.createObjectURL(x);o=u,n(u)}catch(m){console.error("Failed to load profile image blob",m),n(null)}})():n(null),()=>{if(d=!1,o){try{URL.revokeObjectURL(o)}catch{}o=null}}},[c]),i.useEffect(()=>{var x;let d=!0;if(!((x=y())==null?void 0:x.token)){U(!1);return}return(async()=>{var u,t,s;try{const a=await k.me();if(!d)return;const l=a.data,p={id:l.id,fullName:l.fullName,email:l.email,phone:l.phone,role:l.role||((t=(u=y())==null?void 0:u.user)==null?void 0:t.role),hasProfileImage:l.hasProfileImage||!1};f(p),C({...y(),user:p});try{window.dispatchEvent(new Event("auth:update"))}catch{}}catch(a){const l=(s=a==null?void 0:a.response)==null?void 0:s.status;if(l===401||l===403){R();try{window.location.href="/login"}catch{}}else console.error("Failed to fetch user profile:",a)}finally{d&&U(!1)}})(),()=>{d=!1}},[]);const P=i.useCallback(async d=>{var m,x,u,t;I(!0),g(null);try{const s=await k.update(d),a=s.data.user,l={id:a.id,fullName:a.fullName,email:a.email,phone:a.phone,role:a.role||(c==null?void 0:c.role),hasProfileImage:a.hasProfileImage||!1};f(l),C({...y(),user:l});try{window.dispatchEvent(new Event("auth:update"))}catch{}let p=null;if(l.hasProfileImage)try{const S=(await k.profileImage()).data,E=URL.createObjectURL(S);n(E),p=E}catch(b){console.error("Failed to fetch updated profile image",b)}else n(null);return g(((m=s.data)==null?void 0:m.message)||"Profile updated."),{success:!0,newImageUrl:p}}catch(s){const a=(x=s==null?void 0:s.response)==null?void 0:x.status;if(a===401||a===403){R();try{window.location.href="/login"}catch{}return{success:!1}}const l=((t=(u=s==null?void 0:s.response)==null?void 0:u.data)==null?void 0:t.message)||(s==null?void 0:s.message)||"Failed to update profile.";return g(l),{success:!1}}finally{I(!1)}},[c]),w=i.useCallback(()=>{R(),f(null);try{window.dispatchEvent(new Event("auth:update"))}catch{}r("/")},[r]);return{user:c,isLoading:h,isUpdating:L,message:N,profileImageUrl:v,setProfileImageUrl:n,updateProfile:P,logout:w,setMessage:g}}function J(){const{user:r,isLoading:j,isUpdating:c,message:f,profileImageUrl:h,setProfileImageUrl:U,updateProfile:L,logout:I,setMessage:N}=O(),[g,v]=i.useState(!1),[n,o]=i.useState({fullName:"",phone:"",password:""}),[P,w]=i.useState(null),[d,m]=i.useState(null);i.useEffect(()=>{r&&o({fullName:r.fullName||r.name||"",phone:r.phone||"",password:""})},[r]);const x=async t=>{var p;(p=t==null?void 0:t.preventDefault)==null||p.call(t);const s=new FormData;s.append("fullName",n.fullName),s.append("phone",n.phone),n.password&&s.append("password",n.password),P&&s.append("profileImage",P);const{success:a,newImageUrl:l}=await L(s);if(a){if(l){if(h)try{URL.revokeObjectURL(h)}catch{}U(l),m(null)}v(!1),w(null),o(b=>({...b,password:""}))}},u=t=>{const s=t.target.files[0];if(s){if(!["image/jpeg","image/png","image/svg+xml"].includes(s.type)){N("Invalid file type. Please select a PNG, JPG, or SVG image.");return}if(d)try{URL.revokeObjectURL(d)}catch{}w(s),m(URL.createObjectURL(s))}};return j||!r?e.jsx("div",{className:"max-w-3xl py-10 mx-auto",children:e.jsxs("div",{className:"p-6 bg-white rounded shadow",children:[e.jsx("h2",{className:"mb-4 text-xl font-semibold",children:"My Account"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Loading user data..."})]})}):e.jsx("div",{className:"max-w-3xl py-10 mx-auto",children:e.jsxs("div",{className:"p-6 bg-white rounded shadow",children:[e.jsxs("h2",{className:"flex items-center justify-between mb-4 text-xl font-semibold",children:["My Account",!g&&e.jsx("button",{onClick:()=>{v(!0),N(null)},className:"ml-4 text-sm text-[#003366] bg-white border border-[#003366] px-3 py-1 rounded hover:bg-[#003366] hover:text-white transition",children:"Edit"})]}),f&&e.jsx("div",{className:`p-3 mb-4 text-sm border rounded ${f.includes("Failed")||f.includes("Invalid")?"text-red-700 border-red-200 bg-red-50":"text-green-700 border-green-200 bg-green-50"}`,children:f}),g?e.jsxs("form",{onSubmit:x,className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-6 sm:flex-row sm:items-start",children:[e.jsxs("div",{className:"flex flex-col items-center flex-shrink-0 w-full sm:w-auto",children:[e.jsx("label",{htmlFor:"profile-image-upload",className:"cursor-pointer",children:e.jsx("img",{src:d||h||"https://via.placeholder.com/100?text=Avatar",alt:"Profile Preview",className:"object-cover object-top w-24 h-24 border-2 rounded-full border-slate-300"})}),e.jsx("input",{id:"profile-image-upload",type:"file",accept:"image/png, image/jpeg, image/svg+xml",onChange:u,className:"hidden",disabled:c}),e.jsx("p",{className:"mt-2 text-xs text-center text-slate-500",children:"Click image to change"})]}),e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600",children:"Full Name"}),e.jsx("input",{value:n.fullName,onChange:t=>o({...n,fullName:t.target.value}),className:"w-full px-3 py-2 mt-1 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600",children:"Phone"}),e.jsx("input",{value:n.phone,onChange:t=>o({...n,phone:t.target.value}),className:"w-full px-3 py-2 mt-1 border rounded"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600",children:"Email"}),e.jsx("input",{value:r.email,disabled:!0,className:"w-full px-3 py-2 mt-1 border rounded cursor-not-allowed bg-slate-100"}),e.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Email address cannot be changed here."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600",children:"New Password (optional)"}),e.jsx("input",{type:"password",value:n.password,onChange:t=>o({...n,password:t.Targe.value}),className:"w-full px-3 py-2 mt-1 border rounded"}),e.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Leave blank to keep current password."})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{type:"submit",disabled:c,className:"bg-[#003366] text-white px-4 py-2 rounded disabled:opacity-50 hover:bg-[#004488] transition",children:c?"Saving...":"Save Changes"}),e.jsx("button",{type:"button",onClick:()=>{v(!1),o({fullName:r.fullName||"",phone:r.phone||"",password:""}),N(null),m(null),w(null)},className:"px-4 py-2 transition border border-gray-300 rounded hover:bg-gray-100",children:"Cancel"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:h?e.jsx("img",{src:h,alt:"Profile",className:"object-cover object-top w-24 h-24 border-2 rounded-full border-slate-200"}):e.jsx("div",{className:"flex items-center justify-center w-24 h-24 bg-gray-100 border-2 rounded-full border-slate-200",children:e.jsx(A,{size:40,className:"text-gray-400"})})}),e.jsxs("div",{className:"grid flex-1 grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Name"}),e.jsx("p",{className:"font-medium text-gray-800",children:r.fullName||r.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Email"}),e.jsx("p",{className:"font-medium text-gray-800",children:r.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Phone"}),e.jsx("p",{className:"font-medium text-gray-800",children:r.phone||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Role"}),e.jsx("p",{className:"font-medium text-gray-800",children:r.role||"User"})]})]})]}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:I,className:"px-4 py-2 text-white transition bg-red-600 rounded hover:bg-red-700",children:"Logout"})})]})]})})}export{J as default};
